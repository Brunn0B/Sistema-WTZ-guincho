<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Atendimento Guincho</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --primary: #2C3E50;
        --secondary: #34495E;
        --dark: #1A252F;
        --light: #ECF0F1;
        --gray: #95A5A6;
        --light-gray: #BDC3C7;
        --danger: #E74C3C;
        --success: #27AE60;
        --warning: #F39C12;
        --text: #000000;
        --text-light: #7F8C8D;
        --message-in: #FFFFFF;
        --message-out: #D6EAF8;
        --chat-bg: #EAEDED;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Roboto', 'Segoe UI', Oxygen, Ubuntu, sans-serif;
    }

    body {
        background: var(--chat-bg);
        height: 100vh;
        overflow: hidden;
        color: var(--text);
    }

    .header {
        background: var(--dark);
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        position: relative;
        z-index: 10;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .logo-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .logo {
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }

    .logo img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .header-title {
        flex: 1;
    }

    .header-title h1 {
        font-size: 1.2rem;
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    .header-status {
        font-size: 0.75rem;
        opacity: 0.8;
        margin-top: 2px;
    }

    .header-actions {
        display: flex;
        gap: 15px;
    }

    .header-btn {
        background: transparent;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .header-btn:hover {
        background: rgba(255,255,255,0.1);
    }

    .main-container {
        display: flex;
        height: calc(100vh - 66px);
    }

    .sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 1px 0 10px rgba(0,0,0,0.05);
    }

    .search-bar {
        padding: 12px;
        border-bottom: 1px solid #eee;
        background: var(--light);
    }

    .search-bar input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        outline: none;
        font-size: 14px;
        background: white;
        transition: all 0.3s;
    }

    .search-bar input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
    }

    .sidebar-tabs {
        display: flex;
        border-bottom: 1px solid #eee;
        background: var(--light);
    }

    .sidebar-tab {
        flex: 1;
        text-align: center;
        padding: 12px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        font-size: 14px;
        color: var(--text-light);
        position: relative;
    }

    .sidebar-tab.active {
        color: var(--primary);
        font-weight: 600;
    }

    .sidebar-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 3px;
        background: var(--primary);
        border-radius: 3px 3px 0 0;
    }

    .sidebar-tab:hover {
        background: rgba(0,0,0,0.03);
    }

    .chats-list {
        flex: 1;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--light-gray) transparent;
    }

    .chats-list::-webkit-scrollbar {
        width: 6px;
    }

    .chats-list::-webkit-scrollbar-thumb {
        background-color: var(--light-gray);
        border-radius: 3px;
    }

    .chat-item {
        display: flex;
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }

    .chat-item:hover {
        background: #f5f5f5;
    }

    .chat-item.active {
        background: var(--light);
    }

    .chat-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
        font-size: 18px;
    }

    .chat-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .chat-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .chat-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text);
    }

    .chat-time {
        font-size: 11px;
        color: var(--text-light);
        font-weight: 400;
    }

    .chat-preview {
        font-size: 13px;
        color: var(--text-light);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 400;
    }

    .unread-badge {
        background: var(--primary);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        margin-left: auto;
        align-self: center;
        font-weight: 600;
    }

    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--chat-bg);
        position: relative;
    }

    .chat-header {
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        z-index: 5;
        box-shadow: 0 1px 10px rgba(0,0,0,0.1);
    }

    .chat-contact {
        flex: 1;
        display: flex;
        align-items: center;
    }

    .chat-contact-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--secondary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 12px;
        font-size: 16px;
    }

    .chat-contact-name {
        font-weight: 500;
        font-size: 16px;
    }

    .chat-contact-status {
        font-size: 12px;
        opacity: 0.8;
        margin-top: 2px;
    }

    .chat-actions {
        display: flex;
        gap: 15px;
    }

    .chat-action-btn {
        background: transparent;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-action-btn:hover {
        background: rgba(255,255,255,0.1);
    }

    .messages-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .text-messages-column {
        flex: 2;
        padding: 20px;
        overflow-y: auto;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%232C3E50' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
        background-attachment: fixed;
    }

    .media-column {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: white;
        border-left: 1px solid #ddd;
        display: flex;
        flex-direction: column;
    }

    .media-column-header {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--primary);
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .media-column-header i {
        font-size: 18px;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
    }

    .media-item {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #eee;
        transition: all 0.3s;
        cursor: pointer;
    }

    .media-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .media-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
    }

    .document-item {
        padding: 10px;
        background: #f9f9f9;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 5px;
    }

    .document-icon {
        font-size: 24px;
        color: var(--primary);
    }

    .document-name {
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
    }

    .document-date {
        font-size: 10px;
        color: var(--text-light);
    }

    .messages-content {
        display: flex;
        flex-direction: column;
        min-height: min-content;
        flex-grow: 1;
    }

    .message {
        max-width: 80%;
        margin-bottom: 15px;
        position: relative;
        animation: fadeIn 0.3s ease-out;
    }

    .message:last-child {
        margin-bottom: 0;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message-in {
        align-self: flex-start;
    }

    .message-out {
        align-self: flex-end;
    }

    .message-bubble {
        padding: 12px 16px;
        border-radius: 12px;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        line-height: 1.4;
    }

    .message-in .message-bubble {
        background: var(--message-in);
        border-top-left-radius: 0;
        color: var(--text);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .message-out .message-bubble {
        background: var(--message-out);
        border-top-right-radius: 0;
        color: var(--text);
        border: 1px solid rgba(44, 62, 80, 0.1);
    }

    .message-time {
        font-size: 11px;
        color: var(--text-light);
        margin-top: 4px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
    }

    .message-status {
        font-size: 12px;
        color: var(--text-light);
    }

    .message-media {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        margin-top: 5px;
        cursor: pointer;
        transition: transform 0.3s;
        border: 1px solid rgba(0,0,0,0.1);
    }

    .message-media:hover {
        transform: scale(1.02);
    }

    .message-document {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(0,0,0,0.03);
        border-radius: 8px;
        margin-top: 8px;
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.3s;
        cursor: pointer;
    }

    .message-document:hover {
        background: rgba(0,0,0,0.05);
    }

    .document-icon-large {
        font-size: 24px;
        margin-right: 10px;
        color: var(--primary);
    }

    .document-info {
        flex: 1;
        min-width: 0;
    }

    .document-name-large {
        font-weight: 500;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .document-size {
        font-size: 12px;
        color: var(--text-light);
    }

    .quick-replies {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }

    .quick-reply {
        background: var(--light);
        border: 1px solid rgba(44, 62, 80, 0.1);
        border-radius: 16px;
        padding: 6px 12px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .quick-reply:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .input-area {
        background: white;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 5;
        border-top: 1px solid #ddd;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
    }

    .input-area input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 24px;
        outline: none;
        font-size: 15px;
        transition: all 0.3s;
    }

    .input-area input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
    }

    .input-btn {
        background: transparent;
        border: none;
        font-size: 20px;
        color: var(--primary);
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s;
    }

    .input-btn:hover {
        background: rgba(44, 62, 80, 0.1);
    }

    .send-btn {
        background: var(--primary);
        color: white;
    }

    .send-btn:hover {
        background: var(--dark);
    }

    .qr-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(3px);
    }

    .qr-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        max-width: 90%;
        width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .qr-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--dark);
    }

    .qr-image {
        width: 200px;
        height: 200px;
        margin: 15px auto;
        border: 1px solid #ddd;
        background: white;
        padding: 10px;
    }

    .qr-instructions {
        color: var(--text-light);
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.5;
    }

    .qr-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
    }

    .qr-btn:hover {
        background: var(--dark);
        transform: translateY(-1px);
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
    }

    .status-online {
        background: var(--success);
        box-shadow: 0 0 5px var(--success);
    }

    .status-offline {
        background: var(--danger);
    }

    .status-connecting {
        background: var(--warning);
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-light);
        text-align: center;
        padding: 20px;
    }

    .empty-icon {
        font-size: 50px;
        margin-bottom: 15px;
        color: #D5DBDB;
    }

    .empty-title {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 10px;
        color: var(--text);
    }

    .empty-text {
        font-size: 14px;
        max-width: 300px;
        line-height: 1.5;
    }

    .quick-actions {
        background: white;
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .quick-actions-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .quick-action {
        background: var(--light);
        border: 1px solid rgba(44, 62, 80, 0.1);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .quick-action:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .quick-action:hover .quick-action-icon {
        color: white;
    }

    .quick-action-icon {
        font-size: 20px;
        margin-bottom: 5px;
        color: var(--primary);
        transition: all 0.3s;
    }

    .quick-action-label {
        font-size: 12px;
        font-weight: 500;
    }

    
    .file-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        display: none;
        backdrop-filter: blur(3px);
    }

    .file-modal-content {
        background: white;
        border-radius: 12px;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        transform: translateY(20px);
        opacity: 0;
        animation: modalFadeIn 0.3s forwards;
    }

    @keyframes modalFadeIn {
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .file-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .file-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--dark);
    }

    .file-modal-close {
        background: none;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: var(--text-light);
        transition: all 0.3s;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .file-modal-close:hover {
        background: rgba(0,0,0,0.05);
        color: var(--text);
    }

    .file-input-container {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .file-input-container:hover {
        border-color: var(--primary);
        background: rgba(44, 62, 80, 0.02);
    }

    .file-input-icon {
        font-size: 40px;
        color: var(--primary);
        margin-bottom: 10px;
        opacity: 0.8;
    }

    .file-input-label {
        font-weight: 500;
        margin-bottom: 5px;
        color: var(--text);
    }

    .file-input-hint {
        font-size: 12px;
        color: var(--text-light);
        line-height: 1.5;
    }

    .file-preview {
        max-width: 100%;
        max-height: 200px;
        display: none;
        margin: 10px auto;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .file-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 15px;
    }

    .file-modal-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        font-size: 14px;
    }

    .file-modal-cancel {
        background: var(--light);
        color: var(--text);
    }

    .file-modal-cancel:hover {
        background: #E0E0E0;
    }

    .file-modal-send {
        background: var(--primary);
        color: white;
    }

    .file-modal-send:hover {
        background: var(--dark);
        transform: translateY(-1px);
    }

    .file-modal-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    @media (max-width: 768px) {
        .sidebar {
            width: 100%;
            position: absolute;
            z-index: 20;
            height: 100%;
            transform: translateX(-100%);
            transition: transform 0.3s;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .menu-toggle {
            display: block !important;
        }
        
        .quick-actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .message {
            max-width: 90%;
        }
        
        .header-title h1 {
            font-size: 1rem;
        }

        .messages-container {
            flex-direction: column;
        }

        .media-column {
            display: none;
        }
    }

    .hidden {
        display: none !important;
    }

    .visible {
        display: flex !important;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message {
        animation: slideIn 0.3s ease-out forwards;
    }

        .document-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 5px;
            border: 1px solid #eee;
            transition: all 0.3s;
        }

        .document-item:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .document-icon {
            font-size: 24px;
            color: var(--primary);
        }

        .document-name {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .document-type {
            font-size: 10px;
            color: var(--text-light);
            background: #eee;
            padding: 2px 5px;
            border-radius: 4px;
        }

        .document-date {
            font-size: 10px;
            color: var(--text-light);
        }

        .file-pdf { color: #e74c3c; }
        .file-word { color: #2c3e50; }
        .file-excel { color: #27ae60; }
        .file-powerpoint { color: #e67e22; }
        .file-image { color: #3498db; }
        .file-archive { color: #9b59b6; }
        .file-audio { color: #1abc9c; }
        .file-video { color: #e74c3c; }
        .file-code { color: #f39c12; }

        .pdf-preview {
    width: 100%;
    height: 200px;
    border: 1px solid #ddd;
    background: #f5f5f5 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23e74c3c"><path d="M8.267 14.68c-.184 0-.308.018-.372.036v1.178c.076.018.171.023.302.023.479 0 .774-.242.774-.651 0-.366-.254-.586-.704-.586zm3.487.012c-.2 0-.33.018-.407.036v2.61c.077.018.201.018.313.018.817.006 1.349-.444 1.349-1.396.006-.83-.479-1.268-1.255-1.268z"/><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM9.498 16.19c-.309.29-.765.42-1.296.42a2.23 2.23 0 0 1-.308-.018v1.426H7v-3.936A7.558 7.558 0 0 1 8.219 14c.557 0 .953.106 1.22.319.254.202.426.533.426.923-.001.392-.131.723-.367.948zm3.807 1.355c-.42.349-1.059.515-1.84.515-.468 0-.799-.03-1.024-.06v-3.917A7.947 7.947 0 0 1 11.66 14c.757 0 1.249.136 1.633.426.415.308.675.799.675 1.504 0 .763-.279 1.29-.663 1.615zM17 14.77h-1.532v.911H16.9v.734h-1.432v1.604h-.906V14.03H17v.74zM14 9h-1V4l5 5h-4z"/></svg>') no-repeat center center;
    background-size: 50px;
    cursor: pointer;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 10px;
    box-sizing: border-box;
}

.pdf-name {
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    width: calc(100% - 20px);
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
            margin-right: 15px;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .nav-btn.active {
            background: var(--primary);
            font-weight: 500;
        }
        
        .nav-btn i {
            font-size: 16px;
        }

        .info-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1002;
        backdrop-filter: blur(3px);
    }
    
    .info-modal-content {
        background: white;
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        animation: modalFadeIn 0.3s;
    }
    
    .info-modal-header {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--primary);
        color: white;
        border-radius: 10px 10px 0 0;
    }
    
    .info-modal-header h3 {
        margin: 0;
        font-size: 18px;
    }
    
    .info-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    .info-modal-close:hover {
        background: rgba(255,255,255,0.2);
    }
    
    .info-modal-body {
        padding: 20px;
    }
    
    .info-section {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    
    .info-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .info-section h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .info-section h4 i {
        font-size: 18px;
    }
    
    .info-section p, .info-section ul {
        margin: 0;
        color: var(--text);
        line-height: 1.6;
    }
    
    .info-section ul {
        padding-left: 20px;
    }
    
    .status-indicators {
        list-style: none;
        padding-left: 0;
    }
    
    .status-indicators li {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    </style>
</head>
<body>
    <div class="header">
        <button class="header-btn menu-toggle" style="display: none;">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo-container">
            <div class="logo">
            </div>
            <div class="header-title">
                <h1>Atendimento Guincho</h1>
                <div class="header-status">
                    <span class="status-indicator status-connecting"></span>
                    <span id="connection-status">Conectando...</span>
                </div>
            </div>
        </div>

          <div class="nav-buttons">
            <button class="nav-btn active" id="nav-chat">
                <i class="fas fa-comments"></i> Chat
            </button>
            <button class="nav-btn" id="nav-relatorios">
                <i class="fas fa-chart-bar"></i> Relatórios
            </button>
            <button class="nav-btn" id="nav-config">
                <i class="fas fa-cogs"></i> Bot Autonomo
            </button>
        </div>

        <div class="header-actions">
            <button class="header-btn" title="Atualizar" id="refresh-btn">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="chat-action-btn" title="Informações"  id="toggle-chat-info">
                        <i class="fas fa-info-circle"></i>
                    </button>
            <button class="header-btn" title="URL Pública" id="ngrok-btn">
                <i class="fas fa-globe"></i>
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Pesquisar conversas...">
            </div>
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="chats">
                    <i class="fas fa-comments"></i> Conversas
                </div>
            </div>
            <div class="chats-list" id="chats-list">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="empty-title">Carregando conversas...</div>
                    <div class="empty-text">Aguarde enquanto conectamos ao WhatsApp</div>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="quick-actions" id="quick-actions">
                <div class="quick-actions-title">Respostas Rápidas</div>
                <div class="quick-actions-grid" id="quick-actions-grid">
                </div>
            </div>

            <div class="chat-header hidden" id="chat-header">
                <div class="chat-contact">
                    <div class="chat-contact-avatar" id="current-chat-avatar">S</div>
                    <div>
                        <div class="chat-contact-name" id="current-chat-name">Selecione um chat</div>
                        <div class="chat-contact-status" id="current-chat-status">Online</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" title="Ações rápidas" id="toggle-quick-actions">
                        <i class="fas fa-bolt"></i>
                    </button>
                </div>
            </div>

            <div class="info-modal" id="info-modal">
    <div class="info-modal-content">
        <div class="info-modal-header">
            <h3>Guia do Sistema</h3>
            <button class="info-modal-close" id="info-modal-close">&times;</button>
        </div>
        <div class="info-modal-body">
            <div class="info-section">
                <h4><i class="fas fa-info-circle"></i> Sobre o Sistema</h4>
                <p>Este sistema foi desenvolvido para auxiliar usuários com dúvidas sobre serviços de guincho, proporcionando atendimento rápido e eficiente via WhatsApp.</p>
            </div>
            
            <div class="info-section">
                <h4><i class="fas fa-plug"></i> Status de Conexão</h4>
                <ul class="status-indicators">
                    <li><span class="status-indicator status-online"></span> Conectado - Sistema operacional</li>
                    <li><span class="status-indicator status-connecting"></span> Conectando - Aguardando autenticação</li>
                    <li><span class="status-indicator status-offline"></span> Desconectado - Verifique a conexão</li>
                </ul>
            </div>
            
            <div class="info-section">
                <h4><i class="fas fa-globe"></i> URL Pública</h4>
                <p>O sistema gera automaticamente uma URL pública para acesso remoto. Você pode copiá-la clicando no ícone <i class="fas fa-globe"></i> no cabeçalho.</p>
            </div>
            
            <div class="info-section">
                <h4><i class="fas fa-comments"></i> Atendimento</h4>
                <ul>
                    <li>Selecione uma conversa na lista à esquerda</li>
                    <li>Digite mensagens no campo inferior</li>
                    <li>Use o ícone <i class="fas fa-paperclip"></i> para enviar arquivos</li>
                    <li>Clique no ícone <i class="fas fa-bolt"></i> para respostas rápidas</li>
                </ul>
            </div>
            
            <div class="info-section">
                <h4><i class="fas fa-images"></i> Mídias e Documentos</h4>
                <p>Todos os arquivos trocados na conversa são exibidos na coluna direita. Clique em qualquer item para visualizar ou baixar.</p>
            </div>
        </div>
    </div>
</div>

            <div class="messages-container" id="messages-container">
                <div class="text-messages-column" id="text-messages-column">
                    <div class="messages-content" id="messages-content">
                        <div class="empty-state" id="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-comment-dots"></i>
                            </div>
                            <div class="empty-title">Nenhum chat selecionado</div>
                            <div class="empty-text">Selecione uma conversa na lista ao lado para começar a atender</div>
                        </div>
                    </div>
                </div>

                <div class="media-column" id="media-column">
                    <div class="media-column-header">
                        <i class="fas fa-images"></i>
                        <span>Mídias e Documentos</span>
                    </div>
                    <div class="media-grid" id="media-grid">
                    </div>
                </div>
            </div>

            <div class="input-area hidden" id="input-area">
                <button class="input-btn" title="Anexar" id="attach-btn">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="text" id="message-input" placeholder="Digite uma mensagem..." autocomplete="off">
                <button class="input-btn send-btn" id="send-button" title="Enviar">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="qr-modal" id="qr-modal">
        <div class="qr-container">
            <div class="qr-title">Conectar WhatsApp</div>
            <div class="qr-instructions">
                Abra o WhatsApp no seu celular, toque em <strong>Menu → Dispositivos conectados → Conectar um dispositivo</strong> e escaneie o código abaixo
            </div>
            <img class="qr-image" id="qr-image" src="" alt="QR Code">
            <button class="qr-btn" id="close-qr">Fechar</button>
        </div>
    </div>

    <div class="file-modal" id="file-modal">
        <div class="file-modal-content">
            <div class="file-modal-header">
                <div class="file-modal-title">Enviar Arquivo</div>
                <button class="file-modal-close" id="file-modal-close">&times;</button>
            </div>
            <input type="file" id="file-input" style="display: none;">
            <div class="file-input-container" id="file-input-container">
                <div class="file-input-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="file-input-label">Clique para selecionar ou arraste um arquivo</div>
                <div class="file-input-hint">Formatos suportados: JPG, PNG, PDF, DOC, XLS (Max. 15MB)</div>
            </div>
            <img id="file-preview" class="file-preview" src="" alt="Pré-visualização">
            <div class="file-modal-footer">
                <button class="file-modal-btn file-modal-cancel" id="file-modal-cancel">Cancelar</button>
                <button class="file-modal-btn file-modal-send" id="file-modal-send" disabled>Enviar</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
   <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.querySelector('.main-container');
            const relatoriosPage = document.createElement('div');
            const configPage = document.createElement('div');
            
            relatoriosPage.innerHTML = `
                <div style="padding: 20px; background: white; height: 100%;">
                    <h2>Relatórios - ⚙️Ainda em desenvolvimento</h2>
                    <p>Página de relatórios será exibida aqui.</p>
                </div>
            `;
            relatoriosPage.style.display = 'none';
            
            configPage.innerHTML = `
                <div style="padding: 20px; background: white; height: 100%;">
                    <h2>Configurações - ⚙️Ainda em desenvolvimento</h2>
                    <p>Página de configurações será exibida aqui.</p>
                </div>
            `;
            configPage.style.display = 'none';
            
            mainContainer.parentNode.insertBefore(relatoriosPage, mainContainer.nextSibling);
            mainContainer.parentNode.insertBefore(configPage, relatoriosPage.nextSibling);
            
            const navChat = document.getElementById('nav-chat');
            const navRelatorios = document.getElementById('nav-relatorios');
            const navConfig = document.getElementById('nav-config');
            
            function showPage(page) {
                mainContainer.style.display = 'none';
                relatoriosPage.style.display = 'none';
                configPage.style.display = 'none';
                
                navChat.classList.remove('active');
                navRelatorios.classList.remove('active');
                navConfig.classList.remove('active');
                
                if (page === 'chat') {
                    mainContainer.style.display = 'flex';
                    navChat.classList.add('active');
                } else if (page === 'relatorios') {
                    relatoriosPage.style.display = 'block';
                    navRelatorios.classList.add('active');
                } else if (page === 'config') {
                    configPage.style.display = 'block';
                    navConfig.classList.add('active');
                }
            }
            
            navChat.addEventListener('click', () => showPage('chat'));
            navRelatorios.addEventListener('click', () => showPage('relatorios'));
            navConfig.addEventListener('click', () => showPage('config'));
            
            showPage('chat');
        });

 
    const infoModal = document.getElementById('info-modal');
    const toggleChatInfo = document.getElementById('toggle-chat-info');
    const infoModalClose = document.getElementById('info-modal-close');
    
    toggleChatInfo.addEventListener('click', () => {
        infoModal.style.display = 'flex';
    });
    
    infoModalClose.addEventListener('click', () => {
        infoModal.style.display = 'none';
    });
    
    infoModal.addEventListener('click', (e) => {
        if (e.target === infoModal) {
            infoModal.style.display = 'none';
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && infoModal.style.display === 'flex') {
            infoModal.style.display = 'none';
        }
    });

    const sidebar = document.getElementById('sidebar');
    const chatsList = document.getElementById('chats-list');
    const messagesContainer = document.getElementById('messages-container');
    const textMessagesColumn = document.getElementById('text-messages-column');
    const messagesContent = document.getElementById('messages-content');
    const mediaColumn = document.getElementById('media-column');
    const mediaGrid = document.getElementById('media-grid');
    const emptyState = document.getElementById('empty-state');
    const chatHeader = document.getElementById('chat-header');
    const inputArea = document.getElementById('input-area');
    const currentChatName = document.getElementById('current-chat-name');
    const currentChatAvatar = document.getElementById('current-chat-avatar');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const qrModal = document.getElementById('qr-modal');
    const qrImage = document.getElementById('qr-image');
    const closeQrBtn = document.getElementById('close-qr');
    const connectionStatus = document.getElementById('connection-status');
    const statusIndicator = document.querySelector('.status-indicator');
    const searchInput = document.getElementById('search-input');
    const refreshBtn = document.getElementById('refresh-btn');
    const attachBtn = document.getElementById('attach-btn');
    const fileModal = document.getElementById('file-modal');
    const fileInput = document.getElementById('file-input');
    const fileInputContainer = document.getElementById('file-input-container');
    const filePreview = document.getElementById('file-preview');
    const fileModalClose = document.getElementById('file-modal-close');
    const fileModalCancel = document.getElementById('file-modal-cancel');
    const fileModalSend = document.getElementById('file-modal-send');
    const quickActions = document.getElementById('quick-actions');
    const quickActionsGrid = document.getElementById('quick-actions-grid');
    const toggleQuickActions = document.getElementById('toggle-quick-actions');
    const sidebarTabs = document.querySelectorAll('.sidebar-tab');
    const ngrokBtn = document.getElementById('ngrok-btn');

    const socket = io();
    let currentChat = null;
    let chats = new Map();
    let allChats = new Map();
    let selectedFile = null;
    let ngrokUrl = null;
    let mediaItems = [];

    const quickReplies = [
        {
            title: "Saudação",
            icon: "handshake",
            replies: [
                "Bom dia! Em que posso ajudar?",
                "Boa tarde! Como posso ajudar?",
                "Boa noite! Em que posso ajudar?"
            ]
        },
        {
            title: "Confirmação",
            icon: "check-circle",
            replies: [
                "Confirmado!",
                "Entendido, vou verificar.",
                "Recebemos sua solicitação."
            ]
        },
        {
            title: "Informações",
            icon: "info-circle",
            replies: [
                "O horário de atendimento é das 8h às 18h.",
                "Você pode consultar mais informações no site www.semob.gov.br",
                "Para abrir um chamado, preciso de alguns dados: Nome completo, CPF e endereço."
            ]
        },
        {
            title: "Encerramento",
            icon: "sign-out-alt",
            replies: [
                "Fico à disposição para qualquer dúvida!",
                "Agradecemos o contato!",
                "Encerramos aqui o atendimento. Tenha um bom dia!"
            ]
        },
        {
            title: "Documentos",
            icon: "file-alt",
            replies: [
                "Por favor, envie uma foto do documento.",
                "Precisamos do documento com foto para prosseguir.",
                "O documento deve estar legível e com foto."
            ]
        },
        {
            title: "Localização",
            icon: "map-marker-alt",
            replies: [
                "Por favor, envie sua localização.",
                "Você pode nos enviar sua localização pelo WhatsApp?",
                "Precisamos do endereço completo para atendimento."
            ]
        }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.menu-toggle')?.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        closeQrBtn.addEventListener('click', () => {
            qrModal.classList.add('hidden');
        });

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        searchInput.addEventListener('input', filterChats);

        refreshBtn.addEventListener('click', () => {
            socket.emit('request-chat-update');
        });

        attachBtn.addEventListener('click', () => {
            fileModal.classList.add('visible');
        });

        fileModalClose.addEventListener('click', closeFileModal);
        fileModalCancel.addEventListener('click', closeFileModal);

        fileModalSend.addEventListener('click', sendFile);

        fileInput.addEventListener('change', handleFileSelect);
        fileInputContainer.addEventListener('click', () => fileInput.click());
        fileInputContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileInputContainer.style.borderColor = 'var(--primary)';
        });
        fileInputContainer.addEventListener('dragleave', () => {
            fileInputContainer.style.borderColor = '#ddd';
        });
        fileInputContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInputContainer.style.borderColor = '#ddd';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: fileInput });
            }
        });

        toggleQuickActions.addEventListener('click', () => {
            quickActions.style.display = quickActions.style.display === 'none' ? 'block' : 'none';
        });

        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                sidebarTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });

        ngrokBtn.addEventListener('click', () => {
            if (ngrokUrl) {
                navigator.clipboard.writeText(ngrokUrl)
                    .then(() => alert(`URL copiada: ${ngrokUrl}`))
                    .catch(() => prompt('Copie a URL:', ngrokUrl));
            } else {
                alert('URL pública não disponível no momento');
            }
        });

        loadQuickActions();

        if (window.innerWidth <= 768) {
            document.querySelector('.menu-toggle').style.display = 'block';
            mediaColumn.style.display = 'none';
        }
    });

    socket.on('connect', () => {
        updateConnectionStatus('Conectando ao servidor...', 'connecting');
    });

    socket.on('disconnect', () => {
        updateConnectionStatus('Desconectado', 'offline');
    });

    socket.on('qr-update', (qr) => {
        console.log('Recebendo QR Image:', qr.substring(0, 50) + '...');
        qrImage.src = qr;
        qrModal.classList.remove('hidden');
        updateConnectionStatus('Aguardando conexão...', 'connecting');
    });

    socket.on('qr-fallback', (qrText) => {
        console.log('Usando fallback QR:', qrText);
        qrImage.src = '';
        qrImage.alt = 'Scan this QR: ' + qrText;
        qrModal.classList.remove('hidden');
        console.log('QR Code para copiar:', qrText);
    });

    socket.on('whatsapp-status', (status) => {
        if (status === 'ready') {
            qrModal.classList.add('hidden');
            updateConnectionStatus('Conectado', 'online');
            socket.emit('request-chat-update');
        } else if (status === 'connected') {
            updateConnectionStatus('Autenticado', 'connecting');
        }
    });

    socket.on('chat-list-update', (updatedChats) => {
        allChats = new Map(updatedChats);
        chats = new Map(updatedChats);
        renderChatList();
    });

    socket.on('specific-message', ({ chatId, sender, message, timestamp, isMedia, fromMe }) => {
        if (currentChat === chatId) {
            if (isMedia) {
                addMediaMessage(chatId, message, fromMe ? 'out' : 'in', timestamp);
                addMediaToGrid(chatId, message, timestamp, fromMe ? 'out' : 'in');
            } else {
                addMessage(chatId, message, fromMe ? 'out' : 'in', timestamp);
            }
            
            if (!fromMe) {
                socket.emit('mark-read', chatId);
            }
        }
        
        updateUnreadBadge(chatId, !fromMe);
    });

    socket.on('chat-updated', ({ chatId, lastMessage, unread, timestamp }) => {
        if (allChats.has(chatId)) {
            const chat = allChats.get(chatId);
            if (lastMessage) chat.lastMessage = lastMessage;
            if (unread !== undefined) chat.unread = unread;
            if (timestamp) chat.timestamp = timestamp;
            
            updateChatListItem(chatId);
        }
    });

    socket.on('historic-message', ({ chatId, sender, message, timestamp, isMedia, fromMe }) => {
        if (currentChat === chatId) {
            if (isMedia) {
                addMediaMessage(chatId, message, fromMe ? 'out' : 'in', timestamp, true);
                addMediaToGrid(chatId, message, timestamp, fromMe ? 'out' : 'in');
            } else {
                addMessage(chatId, message, fromMe ? 'out' : 'in', timestamp, true);
            }
        }
    });

    socket.on('message-status', ({ chatId, status, messageId, timestamp }) => {
        if (currentChat === chatId) {
            const message = document.querySelector(`.message[data-message-id="${messageId}"]`);
            if (message) {
                const statusElement = message.querySelector('.message-status') || document.createElement('span');
                statusElement.className = 'message-status';
                statusElement.innerHTML = getStatusIcon(status);
                message.querySelector('.message-time').appendChild(statusElement);
            }
        }
    });

    socket.on('file-uploaded', ({ chatId, fileName, fileUrl, timestamp }) => {
        if (currentChat === chatId) {
            addFileMessage(chatId, fileName, fileUrl, 'out', timestamp);
            addFileToGrid(chatId, fileName, fileUrl, timestamp, 'out');
        }
    });

    socket.on('ngrok-url', (url) => {
        ngrokUrl = url;
        console.log('URL pública disponível:', ngrokUrl);
    });

    function updateConnectionStatus(text, status) {
        if (connectionStatus) {
            connectionStatus.textContent = text;
            statusIndicator.className = 'status-indicator';
            statusIndicator.classList.add(`status-${status}`);
        }
    }

    function renderChatList() {
        if (!chatsList) return;
        
        chatsList.innerHTML = '';
        
        if (chats.size === 0) {
            chatsList.innerHTML = `
                <div class="empty-state" style="height: auto; padding: 20px;">
                    <div class="empty-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="empty-title">Nenhuma conversa</div>
                    <div class="empty-text">Quando receber mensagens, elas aparecerão aqui</div>
                </div>
            `;
            return;
        }
        
        const sortedChats = Array.from(chats.entries()).sort((a, b) => {
            return (b[1].timestamp || 0) - (a[1].timestamp || 0);
        });
        
        sortedChats.forEach(([chatId, chat]) => {
            const chatItem = document.createElement('div');
            chatItem.className = `chat-item ${currentChat === chatId ? 'active' : ''}`;
            chatItem.dataset.chatId = chatId;
            chatItem.innerHTML = `
                <div class="chat-avatar">${chat.name?.charAt(0)?.toUpperCase() || 'C'}</div>
                <div class="chat-info">
                    <div class="chat-header">
                        <div class="chat-name">${chat.name || chatId}</div>
                        <div class="chat-time">${formatTime(new Date(chat.timestamp * 1000))}</div>
                    </div>
                    <div class="chat-preview">${truncate(chat.lastMessage || 'Nenhuma mensagem', 30)}</div>
                </div>
                ${chat.unread > 0 ? `<div class="unread-badge">${chat.unread}</div>` : ''}
            `;
            
            chatItem.addEventListener('click', () => {
                selectChat(chatId, chat.name || chatId);
            });
            
            chatsList.appendChild(chatItem);
        });
    }

    function updateChatListItem(chatId) {
        const chat = allChats.get(chatId);
        if (!chat) return;
        
        const item = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
        if (item) {
            item.querySelector('.chat-preview').textContent = truncate(chat.lastMessage || 'Nenhuma mensagem', 30);
            item.querySelector('.chat-time').textContent = formatTime(new Date(chat.timestamp * 1000));
            
            const badge = item.querySelector('.unread-badge');
            if (chat.unread > 0) {
                if (!badge) {
                    const newBadge = document.createElement('div');
                    newBadge.className = 'unread-badge';
                    newBadge.textContent = chat.unread;
                    item.appendChild(newBadge);
                } else {
                    badge.textContent = chat.unread;
                }
            } else if (badge) {
                badge.remove();
            }
        }
    }

    function updateUnreadBadge(chatId, increment = true) {
        if (allChats.has(chatId)) {
            const chat = allChats.get(chatId);
            if (increment && currentChat !== chatId) {
                chat.unread = (chat.unread || 0) + 1;
            } else if (!increment) {
                chat.unread = 0;
            }
            updateChatListItem(chatId);
        }
    }

    function filterChats() {
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm === '') {
            chats = new Map(allChats);
        } else {
            chats = new Map(
                Array.from(allChats).filter(([id, chat]) => 
                    chat.name?.toLowerCase().includes(searchTerm) || 
                    id.includes(searchTerm) ||
                    chat.lastMessage?.toLowerCase().includes(searchTerm)
            ));
        }
        renderChatList();
    }

    function selectChat(chatId, chatName) {
        currentChat = chatId;
        currentChatName.textContent = chatName || chatId;
        currentChatAvatar.textContent = (chatName || chatId).charAt(0).toUpperCase();
        
        emptyState.classList.add('hidden');
        chatHeader.classList.remove('hidden');
        inputArea.classList.remove('hidden');
        
        messagesContent.innerHTML = '';
        mediaGrid.innerHTML = '';
        mediaItems = [];
        
        socket.emit('load-chat-history', { 
            chatId: chatId, 
            limit: 50 
        });
        
        socket.emit('mark-read', chatId);
        updateUnreadBadge(chatId, false);
        
        setTimeout(scrollToBottom, 100);
    }

    function addMessage(chatId, text, type, timestamp = new Date().toISOString(), isHistory = false) {
        if (currentChat !== chatId) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;
        
        messageDiv.innerHTML = `
            <div class="message-bubble">${text}</div>
            <div class="message-time">${formatTime(new Date(timestamp))}</div>
            ${type === 'out' ? '<span class="message-status">🕒</span>' : ''}
        `;
        
        if (isHistory) {
            messagesContent.insertBefore(messageDiv, messagesContent.firstChild);
        } else {
            messagesContent.appendChild(messageDiv);
            scrollToBottom();
        }
    }

    function addMediaMessage(chatId, mediaUrl, type, timestamp = new Date().toISOString(), isHistory = false) {
        if (currentChat !== chatId) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <div>${type === 'in' ? 'Mídia recebida:' : 'Mídia enviada:'}</div>
                <img src="${mediaUrl}" class="message-media" onclick="openMedia('${mediaUrl}')">
            </div>
            <div class="message-time">${formatTime(new Date(timestamp))}</div>
            ${type === 'out' ? '<span class="message-status">🕒</span>' : ''}
        `;
        
        if (isHistory) {
            messagesContent.insertBefore(messageDiv, messagesContent.firstChild);
        } else {
            messagesContent.appendChild(messageDiv);
            scrollToBottom();
        }
    }

    function addFileMessage(chatId, fileName, fileUrl, type, timestamp = new Date().toISOString(), isHistory = false) {
        if (currentChat !== chatId) return;
        
        const fileExt = fileName.split('.').pop().toLowerCase();
        const fileIcon = getFileIcon(fileExt);
        const fileType = getFileType(fileExt);
        const fileClass = getFileClass(fileExt);
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <div>${type === 'in' ? 'Arquivo recebido:' : 'Arquivo enviado:'} <small>(${fileType})</small></div>
                <div class="message-document" onclick="downloadFile('${fileUrl}', '${fileName}')">
                    <div class="document-icon-large ${fileClass}">
                        <i class="fas fa-${fileIcon}"></i>
                    </div>
                    <div class="document-info">
                        <div class="document-name-large">${fileName}</div>
                        <div class="document-size">${formatFileSize(0)}</div>
                    </div>
                </div>
            </div>
            <div class="message-time">${formatTime(new Date(timestamp))}</div>
            ${type === 'out' ? '<span class="message-status">🕒</span>' : ''}
        `;
        
        if (isHistory) {
            messagesContent.insertBefore(messageDiv, messagesContent.firstChild);
        } else {
            messagesContent.appendChild(messageDiv);
            scrollToBottom();
        }
    }

    function addMediaToGrid(chatId, mediaUrl, timestamp, type) {
        if (currentChat !== chatId) return;
        
        const mediaItem = {
            type: 'image',
            url: mediaUrl,
            timestamp: timestamp,
            direction: type
        };
        
        mediaItems.push(mediaItem);
        renderMediaGrid();
    }

function addFileToGrid(chatId, fileName, fileUrl, timestamp, type) {
    if (currentChat !== chatId) return;
    
    const fileExt = fileName.split('.').pop().toLowerCase();
    const fileIcon = getFileIcon(fileExt);
    const fileType = getFileType(fileExt);
    const fileClass = getFileClass(fileExt);
    
    const mediaItem = {
        type: 'document',
        name: fileName,
        url: fileUrl,
        timestamp: timestamp,
        direction: type,
        icon: fileIcon,
        fileType: fileType,
        fileClass: fileClass
    };
    
    mediaItems.push(mediaItem);
    renderMediaGrid();
}
  function renderMediaGrid() {
    mediaGrid.innerHTML = '';
    
    mediaItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    mediaItems.forEach(item => {
        if (item.type === 'image') {
            const mediaElement = document.createElement('div');
            mediaElement.className = 'media-item';
            mediaElement.innerHTML = `
                <img src="${item.url}" onclick="openMedia('${item.url}')" title="Clique para ampliar">
            `;
            mediaGrid.appendChild(mediaElement);
        } else if (item.type === 'document') {
            const docElement = document.createElement('div');
            docElement.className = 'document-item';
            
            if (item.name.toLowerCase().endsWith('.pdf')) {
                docElement.innerHTML = `
                    <div class="pdf-preview" onclick="openMedia('${item.url}')">
                        <div class="pdf-name">${item.name}</div>
                    </div>
                    <div class="document-type">PDF</div>
                    <div class="document-date">${formatTime(new Date(item.timestamp))}</div>
                `;
            } else {
                docElement.innerHTML = `
                    <div class="document-icon ${item.fileClass}">
                        <i class="fas fa-${item.icon}"></i>
                    </div>
                    <div class="document-name" title="${item.name}">${truncate(item.name, 20)}</div>
                    <div class="document-type">${item.fileType}</div>
                    <div class="document-date">${formatTime(new Date(item.timestamp))}</div>
                `;
            }
            
            docElement.addEventListener('click', () => {
                if (!item.name.toLowerCase().endsWith('.pdf')) {
                    downloadFile(item.url, item.name);
                }
            });
            mediaGrid.appendChild(docElement);
        }
    });
}
    function scrollToBottom() {
        setTimeout(() => {
            textMessagesColumn.scrollTop = textMessagesColumn.scrollHeight;
        }, 50);
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && currentChat) {
            const timestamp = new Date().toISOString();
            addMessage(currentChat, message, 'out', timestamp);
            
            socket.emit('send-message', {
                chatId: currentChat,
                message: message
            });
            
            messageInput.value = '';
        }
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const validTypes = ['image/jpeg', 'image/png', 'application/pdf', 
                           'application/msword', 'application/vnd.ms-excel'];
        const maxSize = 15 * 1024 * 1024;

        if (!validTypes.includes(file.type)) {
            alert('Tipo de arquivo não suportado. Por favor, envie JPG, PNG, PDF, DOC ou XLS.');
            return;
        }

        if (file.size > maxSize) {
            alert('O arquivo é muito grande. O tamanho máximo é 15MB.');
            return;
        }

        selectedFile = file;
        fileModalSend.disabled = false;

        if (file.type.includes('image')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                filePreview.src = e.target.result;
                filePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            filePreview.style.display = 'none';
        }
    }

    function sendFile() {
        if (!selectedFile || !currentChat) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const fileData = {
                name: selectedFile.name,
                type: selectedFile.type,
                data: e.target.result.split(',')[1] // Remove o prefixo data:...
            };

            socket.emit('send-file', {
                chatId: currentChat,
                file: fileData
            });

            if (selectedFile.type.includes('image')) {
                addMediaMessage(currentChat, URL.createObjectURL(selectedFile), 'out');
                addMediaToGrid(currentChat, URL.createObjectURL(selectedFile), new Date().toISOString(), 'out');
            } else {
                addFileMessage(currentChat, selectedFile.name, '#', 'out');
                addFileToGrid(currentChat, selectedFile.name, '#', new Date().toISOString(), 'out');
            }

            closeFileModal();
        };

        reader.readAsDataURL(selectedFile);
    }

    function closeFileModal() {
        fileModal.classList.remove('visible');
        fileInput.value = '';
        filePreview.src = '';
        filePreview.style.display = 'none';
        selectedFile = null;
        fileModalSend.disabled = true;
    }

    function loadQuickActions() {
        quickActionsGrid.innerHTML = '';
        
        quickReplies.forEach(category => {
            category.replies.forEach(reply => {
                const action = document.createElement('div');
                action.className = 'quick-action';
                action.innerHTML = `
                    <div class="quick-action-icon">
                        <i class="fas fa-${category.icon}"></i>
                    </div>
                    <div class="quick-action-label">${truncate(reply, 30)}</div>
                `;
                
                action.addEventListener('click', () => {
                    if (currentChat) {
                        sendQuickReply(reply);
                    } else {
                        alert('Selecione um chat primeiro');
                    }
                });
                
                quickActionsGrid.appendChild(action);
            });
        });
    }

    function sendQuickReply(reply) {
        if (!currentChat) return;
        
        const timestamp = new Date().toISOString();
        addMessage(currentChat, reply, 'out', timestamp);
        
        socket.emit('send-message', {
            chatId: currentChat,
            message: reply
        });
    }

    function getFileIcon(ext) {
        const iconMap = {
            'pdf': 'file-pdf',
            'doc': 'file-word',
            'docx': 'file-word',
            'xls': 'file-excel',
            'xlsx': 'file-excel',
            'ppt': 'file-powerpoint',
            'pptx': 'file-powerpoint',
            'txt': 'file-alt',
            'csv': 'file-csv',
            'jpg': 'file-image',
            'jpeg': 'file-image',
            'png': 'file-image',
            'gif': 'file-image',
            'svg': 'file-image',
            'bmp': 'file-image',
            'webp': 'file-image',
            'zip': 'file-archive',
            'rar': 'file-archive',
            '7z': 'file-archive',
            'tar': 'file-archive',
            'gz': 'file-archive',
            'mp3': 'file-audio',
            'wav': 'file-audio',
            'ogg': 'file-audio',
            'mp4': 'file-video',
            'mov': 'file-video',
            'avi': 'file-video',
            'mkv': 'file-video',
            'html': 'file-code',
            'css': 'file-code',
            'js': 'file-code',
            'json': 'file-code',
            'php': 'file-code',
            'py': 'file-code',
            'java': 'file-code',
            'cpp': 'file-code',
            'exe': 'file-download',
            'dmg': 'compact-disc',
            'iso': 'compact-disc'
        };
        
        return iconMap[ext.toLowerCase()] || 'file';
    }

    function getFileType(ext) {
        const typeMap = {
            'pdf': 'PDF',
            'doc': 'Word',
            'docx': 'Word',
            'xls': 'Excel',
            'xlsx': 'Excel',
            'ppt': 'PowerPoint',
            'pptx': 'PowerPoint',
            'jpg': 'Imagem',
            'jpeg': 'Imagem',
            'png': 'Imagem',
            'gif': 'Imagem',
            'mp3': 'Áudio',
            'mp4': 'Vídeo',
            'zip': 'Arquivo Compactado',
            'rar': 'Arquivo Compactado'
        };
        
        return typeMap[ext.toLowerCase()] || 'Arquivo';
    }

    function getFileClass(ext) {
        const classMap = {
            'pdf': 'file-pdf',
            'doc': 'file-word',
            'docx': 'file-word',
            'xls': 'file-excel',
            'xlsx': 'file-excel',
            'ppt': 'file-powerpoint',
            'pptx': 'file-powerpoint',
            'jpg': 'file-image',
            'jpeg': 'file-image',
            'png': 'file-image',
            'gif': 'file-image',
            'mp3': 'file-audio',
            'mp4': 'file-video',
            'zip': 'file-archive',
            'rar': 'file-archive'
        };
        
        return classMap[ext.toLowerCase()] || '';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function getStatusIcon(status) {
        switch(status) {
            case 'sent': return '✓';
            case 'delivered': return '✓✓';
            case 'read': return '✓✓✓';
            default: return '🕒';
        }
    }

    function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(date) {
        return date.toLocaleDateString([], { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function truncate(text, length) {
        return text.length > length ? text.substring(0, length) + '...' : text;
    }

    window.openMedia = function(url) {
        window.open(url, '_blank');
    };

    window.downloadFile = function(url, fileName) {
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
    };
</script>
</body>
</html>